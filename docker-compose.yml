services:
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: mqtt
    ports:
      - "1883:1883"
    volumes:
      - ./mqtt/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt_data:/mosquitto/data
      - mqtt_log:/mosquitto/log
    restart: unless-stopped

  edge:
    build: ./edge
    container_name: edge
    depends_on:
      - mqtt
    env_file:
      - .env
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: backend
    depends_on:
      - mqtt
    env_file:
      - .env
    ports:
      - "${BACKEND_HTTP_PORT:-8080}:8080"
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prom_data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    restart: unless-stopped

# (Opcional futuro) simulaci√≥n PX4 en profile separado.
# PX4 Docker existe oficialmente como toolchain, pero la conectividad MAVLink en contenedores
# suele requerir configurar bien puertos/broadcast. Por eso lo dejamos fuera del core. :contentReference[oaicite:3]{index=3}

volumes:
  mqtt_data:
  mqtt_log:
  prom_data:
  grafana_data:
